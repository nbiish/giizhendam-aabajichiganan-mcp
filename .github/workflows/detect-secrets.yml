name: Pre-Commit Secret Detection

on:
  push:
    branches: [ main, dev, staging ]
  pull_request:
    branches: [ main ]

jobs:
  detect-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Check if BASE and HEAD are different (Push)
        if: github.event_name == 'push'
        id: check_diff
        run: |
          if [ "${{ github.event.before }}" == "${{ github.event.after }}" ] || [ -z "${{ github.event.before }}" ]; then
            echo "same_commit=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è BASE and HEAD are the same or before commit is missing. Will scan entire repo."
          else
            echo "same_commit=false" >> $GITHUB_OUTPUT
            echo "‚úÖ BASE and HEAD are different. Will scan diff."
          fi

      - name: TruffleHog OSS (Push - Diff)
        if: github.event_name == 'push' && steps.check_diff.outputs.same_commit == 'false'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --debug --only-verified

      - name: TruffleHog OSS (Push - Full Scan)
        if: github.event_name == 'push' && steps.check_diff.outputs.same_commit == 'true'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  custom-patterns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for specific secrets
        run: |
          echo "üîç Scanning for known secret patterns..."
          
          # Define patterns
          PATTERNS=(
            "BSA[a-zA-Z0-9]{27}"
            "tvly-[a-zA-Z0-9-]{30,}"
            "/Volumes/1tb-sandisk/"
            "/Users/[^/]+/"
            "BRAVE_API_KEY.*[\"'][^\"']{10,}[\"']"
            "tavilyApiKey=[^&\"\\s]{10,}"
            "OPENROUTER_API_KEY.*[\"']sk-or-v1-[^\"']{20,}[\"']"
            "sk-or-v1-[a-zA-Z0-9]{60,}"
          )
          
          FOUND=0
          
          # Scan repository (excluding common directories)
          EXCLUDE_DIRS="node_modules|.git|dist|coverage|.next|.cache"
          
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE --exclude-dir={node_modules,.git,dist,coverage,.next,.cache} --exclude="*.lock" "$pattern" . 2>/dev/null; then
              echo "‚ùå Found pattern: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è SECRETS DETECTED! Please run './sanitize-settings.sh' locally"
            exit 1
          else
            echo "‚úÖ No secrets detected"
          fi

      - name: Comment on PR if secrets found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üö® **Secrets Detected in PR**\n\n' +
                    'This PR contains API keys or sensitive paths.\n\n' +
                    '**Please:**\n' +
                    '1. Run `./sanitize-settings.sh` locally\n' +
                    '2. Review and commit the changes\n' +
                    '3. Push to update this PR\n\n' +
                    '**Or use the template:**\n' +
                    '`CONFIGURATIONS/MCP/settings.json.template`'
            })
